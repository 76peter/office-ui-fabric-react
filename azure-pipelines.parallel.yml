pr:
  - master

trigger:
  - master

variables:
  - group: fabric-variables

jobs:
  - job: Build
    pool: Docker Build
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'

    - task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@3
      displayName: 'Use Yarn 1.19.x'
      inputs:
        versionSpec: 1.19.x
        checkLatest: true
        includePrerelease: false

    - script: |
        yarn
      displayName: yarn

    - script: |
        npm run checkchange
      displayName: check change

    - script: |
        npm run buildci
      displayName: build ci

    - task: AzureUpload@1
      displayName: Upload PR deploy site
      inputs:
        SourcePath: 'apps/pr-deploy-site/dist'
        azureSubscription: 'UI Fabric (bac044cf-49e1-4843-8dda-1ce9662606c8)'
        storage: fabricweb
        ContainerName: '$web'
        BlobPrefix: 'pr-deploy-site/$(Build.SourceBranch)'

    - publish: $(Build.Build.Repository.LocalPath)
      artifact: Build

  # TODO: what is running Checkout task for all jobs? may not be needed
  # TODO: make sure test jobs work even on clean images (with neither reusing an agent with build artifacts)
  - job: PerfTest
    pool: Docker Test
    dependsOn: Build
    steps:
    - checkout: none

    # TODO: optimize this based on what perf-test needs. yarn and built bundle?
    # It seems using DownloadPipelineArtifact@2 instead of 'download:current' is required to use path
    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: Build
        path: $(Build.Repository.LocalPath)

    - script: |
        npm run just perf-test
      workingDirectory: apps/perf-test
      displayName: Perf Test

    - task: AzureUpload@1
      displayName: Upload Perf Test Result to PR deploy site
      inputs:
        SourcePath: 'apps/perf-test/dist'
        azureSubscription: 'UI Fabric (bac044cf-49e1-4843-8dda-1ce9662606c8)'
        storage: fabricweb
        ContainerName: '$web'
        BlobPrefix: 'pr-deploy-site/$(Build.SourceBranch)/perf-test'

    - task: GithubPRComment@0
      displayName: 'Post Perf Results to Github Pull Request'
      inputs:
        githubOwner: OfficeDev
        githubRepo: 'office-ui-fabric-react'
        blobFilePath: '$(Build.SourcesDirectory)/$(PerfCommentFilePath)'
        status: '$(PerfCommentStatus)'
        uniqueId: 'perfComment9423'

    - task: GithubPRStatus@0
      displayName: 'Update Github Pull Request Status'
      inputs:
        githubOwner: OfficeDev
        githubRepo: 'office-ui-fabric-react'
        githubContext: 'Pull Request Deployed Site'
        githubDescription: 'Click "Details" to go to the Deployed Site'
        githubTargetLink: 'http://fabricweb.z5.web.core.windows.net/pr-deploy-site/$(Build.SourceBranch)/'

    # a11y-tests disabled until occasional local and CI timeout issue can be resolved.
    #- task: PublishBuildArtifacts@1
    #  inputs:
    #    pathtoPublish: './apps/a11y-tests/dist/reports'
    #    artifactName: 'CodeAnalysisLogs'
    #  displayName: publish sarif a11y reports

  - job: VRTest
    pool: Docker Test
    dependsOn: Build
    steps:
    - checkout: none

    # TODO: optimize this based on what VR test needs.
    # It seems using DownloadPipelineArtifact@2 instead of 'download:current' is required to use path
    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: Build
        path: $(Build.Repository.LocalPath)

    - script: |
        git config --global user.email "fabrictactical@microsoft.com"
        git config --global user.name "Fabric Tactical"
        npm run vrtest -- --debug
      displayName: run VR Test
      env:
        SCREENER_API_KEY: $(screener.key)

    - script: |
        npm run check-for-changed-files
      displayName: check for change file
